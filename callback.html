<!DOCTYPE html>
<html>
<head>
<script>

var token;

var xhrRequest = function (url, type, callback) {
	  var xhr = new XMLHttpRequest();
	  xhr.onload = function () {
	    callback(this.responseText);
	  };
	  xhr.open(type, url);
	  xhr.send();
	};

function getUrlParameter(sParam)
{
    console.log(window.location);
    var sPageURL = window.location.hash.substring(1);
    var sURLVariables = sPageURL.split('&');
    console.log(sURLVariables);
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1];
        }
    }
}

//this is basically the same as getURLParameter, check if they are both exactly the same later and get rid of one
function getQueryParam(variable, defaultValue) 
{
	  // Find all URL parameters
	  var query = location.search.substring(1);
	  var vars = query.split('&');
	  for (var i = 0; i < vars.length; i++) {
		var pair = vars[i].split('=');

		// If the query variable parameter is found, decode it to use and return it for use
		if (pair[0] === variable) {
		  return decodeURIComponent(pair[1]);
		}
	  }
	  return defaultValue || false;
}

function getEmailFromGoogle(responseText) 
{
	var json = JSON.parse(responseText);
	var loginData = {token:token, email:json.email, googleToken:true};
	var return_to = getQueryParam('return_to', 'pebblejs://close#');
    location.href = return_to + encodeURIComponent(JSON.stringify(loginData));
}

function run()
{
    token = getUrlParameter('access_token');
	var email = xhrRequest('https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=' + token, 'GET', getEmailFromGoogle);

}
window.onload = run()
window.onerror = function(msg, url, line, col, error) {
   // Note that col & error are new to the HTML 5 spec and may not be 
   // supported in every browser.  It worked for me in Chrome.
   var extra = !col ? '' : '\ncolumn: ' + col;
   extra += !error ? '' : '\nerror: ' + error;

   // You can view the information in an alert to see things working like this:
   alert("Error: " + msg + "\nurl: " + url + "\nline: " + line + extra);

   // TODO: Report this error via ajax so you can keep track
   //       of what pages have JS issues

   var suppressErrorAlert = true;
   // If you return true, then error alerts (like in older versions of 
   // Internet Explorer) will be suppressed.
   return suppressErrorAlert;
};

</script>
</head>
<body>

<h2></h2>
<div id="myDiv"></div>

</body>
</html>
