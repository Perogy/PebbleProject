<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="application/x-www-form-urlencoded"/>
<script src="jquery-2.1.3.js"></script>

</head>
<body>

<h2></h2>
<div id="myDiv"></div>

<script>





/**
 * Make a X-Domain request to url and callback.
 *
 * @param url {String}
 * @param method {String} HTTP verb ('GET', 'POST', 'DELETE', etc.)
 * @param data {String} request body
 * @param callback {Function} to callback on completion
 * @param errback {Function} to callback on error
 */
function xdr(url, method, data, callback, errback) {
    var req;
    
    if(XMLHttpRequest) {
        req = new XMLHttpRequest();

        if('withCredentials' in req) {
            req.open(method, url, true);
            req.onerror = errback;
            req.onreadystatechange = function() {
                if (req.readyState === 4) {
                    if (req.status >= 200 && req.status < 400) {
                        callback(req.responseText);
                    } else {
                        errback(new Error('Response returned with non-OK status'));
                    }
                }
            };
            req.send(data);
        }
    } else if(XDomainRequest) {
        req = new XDomainRequest();
        req.open(method, url);
        req.onerror = errback;
        req.onload = function() {
            callback(req.responseText);
        };
        req.send();
    } else {
        errback(new Error('CORS not supported'));
    }
}




var token;
var code;
var state;

var xhrRequest = function (url, type, callback) 
{
	try
	{
	  var xhr = new XMLHttpRequest();
	  xhr.onload = function () {
	    callback(this.responseText);
	  };
	  xhr.open(type, url);
	  xhr.send();
	}
	catch(err)
	{
		document.getElementById("myDiv").innerHTML = err.message;
	}
};

function getQueryParam(variable, defaultValue) 
{
	  // Find all URL parameters
	  var query = location.search.substring(1);
	  var vars = query.split('&');
	  for (var i = 0; i < vars.length; i++) {
		var pair = vars[i].split('=');

		// If the query variable parameter is found, decode it to use and return it for use
		if (pair[0] === variable) {
		  return decodeURIComponent(pair[1]);
		}
	  }
	  return defaultValue || false;
}

function getTokenFromTodoist(responseText) 
{
	var json = JSON.parse(responseText);
	var loginData = {code:code, state:state, todoistToken:true};
	var return_to = getQueryParam('return_to', 'pebblejs:///close#');
    location.href = return_to + encodeURIComponent(JSON.stringify(loginData));
}

function run()
{
	try
	{
		code = getQueryParam('code');
		state = getQueryParam('state');
		var loginData = {code:code, state:state, todoistToken:true};
		var return_to = getQueryParam('return_to', 'pebblejs:///close#');
        location.href = return_to + encodeURIComponent(JSON.stringify(loginData));
		//alert(code);
		//location.href = 'https://todoist.com/oauth/access_token?client_id=2a11ee6e18fe46ad89f9dcbd5507b76b?client_secret=cc88177b38774df2acfedd668be53824?code=' + token + '?redirect_uri=https://perogy.github.io/PebbleProject/callbackTodoist.html'
		//var email = xhrRequest('https://todoist.com/oauth/access_token?client_id=2a11ee6e18fe46ad89f9dcbd5507b76b?client_secret=cc88177b38774df2acfedd668be53824?code=' + code, 'POST', getTokenFromTodoist);
		//$.getJSON('https://todoist.com/oauth/access_token?client_id=2a11ee6e18fe46ad89f9dcbd5507b76b?client_secret=cc88177b38774df2acfedd668be53824?code=' + code, function(data)
		//			  {
		//				  getTokenFromTodoist(data)
		//			  });
		//xdr('https://todoist.com/oauth/access_token', 'POST', 'client_id=2a11ee6e18fe46ad89f9dcbd5507b76b?client_secret=cc88177b38774df2acfedd668be53824?code=' + code, getTokenFromTodoist, setError);
	}
	catch(err)
	{
		document.getElementById("myDiv").innerHTML = err.message;
	}

}

function setError(err)
{
	document.getElementById("myDiv").innerHTML = err.message
}
window.onload = run()

</script>

</body>
</html>
